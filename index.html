<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AlgoMaster Pro – JSON Error Fixed</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism.min.css" rel="stylesheet">
<style>
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;overflow:hidden;font-family:'Segoe UI',sans-serif}
    .container{display:flex;height:100vh}
    .sidebar{width:320px;background:#2c3e50;color:#ecf0f1;display:flex;flex-direction:column;overflow:hidden}
    .sidebar-header{padding:20px 20px 10px}
    .sidebar h2{font-size:1.3em;text-align:center;margin-bottom:10px}
    .upload-btn,.btn-small{display:block;width:100%;padding:10px;background:#3498db;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:bold;text-align:center;margin-bottom:10px}
    .upload-btn:hover,.btn-small:hover{background:#2980b9}
    #fileInput{display:none}
    .search-box{width:100%;padding:10px;border-radius:6px;border:1px solid #34495e;background:#34495e;color:#fff;margin-bottom:10px}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
    .btn-small{padding:6px 10px;font-size:0.85em;background:#34495e}
    .btn-small:hover{background:#3d566e}
    .nav{flex:1;overflow-y:auto;padding:0 20px 20px}
    .section{margin:10px 0}
    .section>h3{background:#34495e;padding:10px;border-radius:5px;cursor:pointer;font-size:0.95em;user-select:none;display:flex;justify-content:space-between;align-items:center}
    .section>h3:hover{background:#3d566e}
    .items{margin-left:12px;display:none}
    .items.active{display:block}
    .item{padding:7px 10px;cursor:pointer;border-radius:4px;margin:3px 0;display:flex;justify-content:space-between;align-items:center;font-size:0.9em}
    .item:hover{background:#46627a}
    .item.active{background:#27ae60;color:#fff}
    .item.compare-select{background:#9b59b6;color:#fff}
    .main{flex:1;background:#fff;overflow-y:auto;padding:30px;position:relative}
    .card{background:#fff;border:1px solid #ddd;border-radius:12px;padding:25px;box-shadow:0 4px 12px rgba(0,0,0,.08);display:none;margin-bottom:25px}
    .card.active{display:block}
    .card .name{font-size:1.8em;font-weight:bold;margin-bottom:15px;color:#2c3e50}
    .card .complexity{background:#e8f4fd;padding:12px;border-radius:8px;margin:15px 0;font-family:monospace;border-left:4px solid #3498db}
    .card .pseudocode{background:#2d2d2d;color:#f8f8f2;padding:15px;border-radius:8px;margin:15px 0;font-family:'Courier New',monospace;white-space:pre-wrap;overflow-x:auto;border-left:4px solid #27ae60}
    .card .usage strong{color:#e67e22}
    .card .usage ul{margin-top:8px;padding-left:22px}
    .compare-panel{background:#f8f9fa;padding:20px;border-radius:10px;margin:20px 0;display:none}
    .compare-panel.active{display:block}
    .compare-grid{display:grid;grid-template-columns:1fr 1fr;gap:25px}
    .compare-card{padding:20px;background:#fff;border:1px solid #ddd;border-radius:10px}
    .compare-card .name{font-size:1.4em;color:#2c3e50;margin-bottom:10px}
    .no-data{color:#95a5a6;text-align:center;margin:50px 0;font-style:italic}
    .error{color:#e74c3c;background:#fadbd8;padding:12px;border-radius:6px;margin:15px 0}
</style>
</head>
<body>

<div class="container">
    <!-- SIDEBAR -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h2>AlgoMaster Pro</h2>
            <button class="upload-btn" id="uploadBtn">Upload JSON</button>
            <input type="file" id="fileInput" accept=".json">
            <input type="text" id="searchBox" class="search-box" placeholder="Search...">
            <div class="controls">
                <button class="btn-small" id="themeBtn">Dark</button>
                <button class="btn-small" id="compareBtn">Compare</button>
                <button class="btn-small" id="showCompareBtn" style="display:none">Show Comparison</button>
            </div>
        </div>
        <div id="nav" class="nav"></div>
    </div>

    <!-- MAIN -->
    <div class="main">
        <div id="content">
            <p class="no-data">Upload a valid <code>.json</code> file to begin.</p>
        </div>
        <div id="comparePanel" class="compare-panel"></div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script>
<script>
let jsonData = null;
let allNavItems = [];
let selectedForCompare = [];
let isCompareMode = false;
const navDiv = document.getElementById('nav');
const contentDiv = document.getElementById('content');
const comparePanel = document.getElementById('comparePanel');
const searchBox = document.getElementById('searchBox');

/* ---------- UPLOAD WITH VALIDATION ---------- */
document.getElementById('uploadBtn').onclick = () => document.getElementById('fileInput').click();
document.getElementById('fileInput').onchange = e => {
    const file = e.target.files[0];
    if (!file) return;

    // Check file extension
    if (!file.name.toLowerCase().endsWith('.json')) {
        showError('Please upload a <strong>.json</strong> file (not HTML, TXT, etc.)');
        return;
    }

    const reader = new FileReader();
    reader.onload = ev => {
        const text = ev.target.result.trim();

        // Prevent HTML files
        if (text.startsWith('<!DOCTYPE') || text.startsWith('<html') || text.includes('<head')) {
            showError('Invalid file: This is an <strong>HTML</strong> file, not JSON.<br><br>Save your data as <code>algorithms.json</code> with valid JSON format.');
            return;
        }

        try {
            jsonData = JSON.parse(text);
            buildUI();
        } catch (err) {
            showError(`Invalid JSON: ${err.message}<br><br>Make sure your file contains valid JSON (e.g., starts with <code>{</code> or <code>[</code>).`);
        }
    };
    reader.readAsText(file);
};

/* ---------- SEARCH ---------- */
searchBox.oninput = () => {
    const term = searchBox.value.toLowerCase().trim();
    allNavItems.forEach(i => {
        const match = term === '' || i.name.toLowerCase().includes(term);
        i.element.style.display = match ? 'block' : 'none';
    });
};

/* ---------- DARK MODE ---------- */
let isDark = false;
document.getElementById('themeBtn').onclick = () => {
    isDark = !isDark;
    document.body.style.background = isDark ? '#1e1e1e' : '#f9f9fb';
    document.querySelector('.main').style.background = isDark ? '#2d2d2d' : '#fff';
    document.querySelector('.main').style.color = isDark ? '#eee' : '#333';
    document.getElementById('themeBtn').textContent = isDark ? 'Light' : 'Dark';
};

/* ---------- COMPARISON MODE ---------- */
document.getElementById('compareBtn').onclick = () => {
    isCompareMode = !isCompareMode;
    const btn = document.getElementById('compareBtn');
    btn.textContent = isCompareMode ? 'Cancel Compare' : 'Compare';
    btn.style.background = isCompareMode ? '#e74c3c' : '#3498db';

    if (!isCompareMode) {
        selectedForCompare = [];
        document.querySelectorAll('.item.compare-select').forEach(el => el.classList.remove('compare-select'));
        document.getElementById('showCompareBtn').style.display = 'none';
        comparePanel.classList.remove('active');
    } else {
        alert('Click 2 algorithms to compare');
    }
};

document.getElementById('showCompareBtn').onclick = () => {
    if (selectedForCompare.length !== 2) return;
    renderComparison(selectedForCompare[0], selectedForCompare[1]);
};

/* ---------- CLICK HANDLER ---------- */
function handleItemClick(e, item, algo, id) {
    e.stopPropagation();

    if (isCompareMode) {
        toggleCompareSelection(item, algo);
    } else {
        showCard(createAlgoCard(algo, id));
        document.querySelectorAll('.item.active').forEach(i => i.classList.remove('active'));
        item.classList.add('active');
    }
}

function toggleCompareSelection(item, algo) {
    const idx = selectedForCompare.findIndex(a => a.name === algo.name);
    if (idx === -1 && selectedForCompare.length < 2) {
        selectedForCompare.push(algo);
        item.classList.add('compare-select');
    } else if (idx !== -1) {
        selectedForCompare.splice(idx, 1);
        item.classList.remove('compare-select');
    } else {
        alert('Only 2 algorithms can be compared');
        return;
    }
    document.getElementById('showCompareBtn').style.display = selectedForCompare.length === 2 ? 'block' : 'none';
}

function renderComparison(algo1, algo2) {
    comparePanel.innerHTML = `
        <h2 style="margin-bottom:15px;color:#2c3e50">Comparison</h2>
        <div class="compare-grid">
            ${createCompareCard(algo1)}
            ${createCompareCard(algo2)}
        </div>
        <button class="btn-small" onclick="document.getElementById('comparePanel').classList.remove('active');" style="margin-top:15px">Close</button>
    `;
    comparePanel.classList.add('active');
    Prism.highlightAllUnder(comparePanel);
}

function createCompareCard(algo) {
    let html = `<div class="compare-card"><div class="name">${escape(algo.name)}</div>`;
    if (algo.complexity) {
        if (typeof algo.complexity === 'object') {
            html += `<div class="complexity"><strong>Complexity:</strong><br>` +
                    Object.entries(algo.complexity).map(([k,v]) => `• <strong>${k}:</strong> ${escape(v)}`).join('<br>') +
                    `</div>`;
        } else {
            html += `<div class="complexity"><strong>Complexity:</strong> ${escape(algo.complexity)}</div>`;
        }
    }
    const pseudo = getAnyField(algo, ['pseudocode']);
    if (pseudo) {
        const code = Array.isArray(pseudo) ? pseudo.join('\n') : pseudo;
        html += `<pre><code class="language-javascript">${escape(code)}</code></pre>`;
    }
    const usage = getAnyField(algo, ['usage']);
    if (usage) {
        const list = Array.isArray(usage) ? usage : [usage];
        html += `<div class="usage"><strong>Usage:</strong><ul>` +
                list.map(u => `<li>${escape(u)}</li>`).join('') +
                `</ul></div>`;
    }
    html += `</div>`;
    return html;
}

/* ---------- BUILD UI ---------- */
function buildUI() {
    navDiv.innerHTML = '';
    contentDiv.innerHTML = '<p class="no-data">Select an item to view details.</p>';
    allNavItems = [];
    selectedForCompare = [];
    isCompareMode = false;

    if (jsonData["All Algoe"]) renderOverview();
    if (jsonData.data_structures) renderSection('Data Structures', jsonData.data_structures, 'ds');
    if (jsonData.algorithm_categories) renderSection('Algorithm Categories', jsonData.algorithm_categories, 'algo');

    addMissingAlgorithms();
}

/* ---------- MISSING ALGORITHMS ---------- */
function addMissingAlgorithms() {
    const builtin = [
        {
            name: "A* Search Algorithm",
            complexity: { time: "O(b^d)", space: "O(b^d)" },
            pseudocode: ["function A*(start, goal):", "    openSet = PriorityQueue...", "..."],
            usage: ["Pathfinding", "Games"]
        },
        {
            name: "Floyd-Warshall Algorithm",
            complexity: { time: "O(V^3)", space: "O(V^2)" },
            pseudocode: ["function FloydWarshall(graph):", "    for k, i, j: update..."],
            usage: ["All-pairs shortest paths"]
        }
    ];

    const sec = createSection('Graph (Built-in)');
    const list = document.createElement('div'); list.className = 'items active';
    builtin.forEach((algo, idx) => {
        const id = `builtin-${idx}`;
        const item = document.createElement('div');
        item.className = 'item';
        item.textContent = algo.name;
        item.onclick = (e) => handleItemClick(e, item, algo, id);
        allNavItems.push({ name: algo.name, element: item });
        list.appendChild(item);
    });
    sec.appendChild(list);
    navDiv.appendChild(sec);
}

/* ---------- OVERVIEW ---------- */
function renderOverview() {
    const sec = createSection('Overview');
    const list = document.createElement('div'); list.className = 'items active';
    (jsonData["All Algoe"] || []).forEach(txt => {
        const [name, desc = ''] = txt.split(':').map(s => s.trim());
        const item = document.createElement('div');
        item.className = 'item';
        item.textContent = name;
        item.onclick = (e) => {
            if (isCompareMode) {
                e.stopPropagation();
                alert('Use Compare mode to select algorithms');
            } else {
                showCard(createOverviewCard(name, desc));
                document.querySelectorAll('.item.active').forEach(i => i.classList.remove('active'));
                item.classList.add('active');
            }
        };
        allNavItems.push({ name, element: item });
        list.appendChild(item);
    });
    sec.appendChild(list);
    navDiv.appendChild(sec);
}

/* ---------- SECTION RENDERER ---------- */
function renderSection(title, categories, prefix) {
    const sec = createSection(title);
    categories.forEach((cat, cIdx) => {
        const catName = cat.category || cat.name || 'Unnamed';
        const catDiv = document.createElement('div'); catDiv.className = 'items';

        let children = cat.items || cat.elements || cat.algorithms || [];
        if (!Array.isArray(children) && children && children.name) children = [children];

        children.forEach((algo, aIdx) => {
            if (!algo || !algo.name) return;
            
            // Handle nested operations (like BST operations)
            if (algo.operation && Array.isArray(algo.operation)) {
                algo.operation.forEach((op, opIdx) => {
                    const id = `${prefix}-${cIdx}-${aIdx}-${opIdx}`;
                    const nav = document.createElement('div');
                    nav.className = 'item';
                    nav.textContent = op.name;
                    nav.onclick = (e) => handleItemClick(e, nav, op, id);
                    allNavItems.push({ name: op.name, element: nav });
                    catDiv.appendChild(nav);
                });
            } else {
                const id = `${prefix}-${cIdx}-${aIdx}`;
                const nav = document.createElement('div');
                nav.className = 'item';
                nav.textContent = algo.name;
                nav.onclick = (e) => handleItemClick(e, nav, algo, id);
                allNavItems.push({ name: algo.name, element: nav });
                catDiv.appendChild(nav);
            }
        });

        const header = document.createElement('h3');
        header.textContent = catName;
        header.onclick = () => catDiv.classList.toggle('active');
        sec.appendChild(header);
        sec.appendChild(catDiv);
    });
    navDiv.appendChild(sec);
}
/* ---------- HELPERS ---------- */
function createSection(title) {
    const div = document.createElement('div'); div.className = 'section';
    const h = document.createElement('h3');
    h.textContent = title;
    h.onclick = () => div.querySelectorAll('.items').forEach(i => i.classList.toggle('active'));
    div.appendChild(h);
    return div;
}

/* ---------- CARDS ---------- */
function createOverviewCard(name, desc) {
    const card = document.createElement('div'); card.className = 'card active';
    card.innerHTML = `<div class="name">${escape(name)}</div><p>${escape(desc)}</p>`;
    return card;
}

function createAlgoCard(algo, id) {
    const card = document.createElement('div'); card.className = 'card'; card.id = id + '-card';
    let html = `<div class="name">${escape(algo.name)}</div>`;

    if (algo.complexity) {
        if (typeof algo.complexity === 'object') {
            html += `<div class="complexity"><strong>Complexity:</strong><br>` +
                    Object.entries(algo.complexity).map(([k,v]) => `• <strong>${k}:</strong> ${escape(v)}`).join('<br>') +
                    `</div>`;
        } else {
            html += `<div class="complexity"><strong>Complexity:</strong> ${escape(algo.complexity)}</div>`;
        }
    }

    const pseudo = getAnyField(algo, ['pseudocode', 'operation.pseudocode', 'description.pseudocode', 'description.0.pseudocode']);
    if (pseudo) {
        const code = Array.isArray(pseudo) ? pseudo.join('\n') : pseudo;
        html += `<pre><code class="language-javascript">${escape(code)}</code></pre>`;
    }

    const usage = getAnyField(algo, ['usage', 'description.usage', 'description.0.usage']);
    if (usage) {
        const list = Array.isArray(usage) ? usage : [usage];
        html += `<div class="usage"><strong>Usage:</strong><ul>` +
                list.map(u => `<li>${escape(u)}</li>`).join('') +
                `</ul></div>`;
    }

    card.innerHTML = html;
    setTimeout(() => Prism.highlightAllUnder(card), 0);
    return card;
}

/* ---------- UNIVERSAL FIELD LOOKUP ---------- */
function getAnyField(obj, paths) {
    for (const path of paths) {
        const parts = path.split('.');
        let value = obj;
        for (const part of parts) {
            if (value && value[part] !== undefined) {
                value = value[part];
            } else {
                value = null;
                break;
            }
        }
        if (value !== null) return value;
    }
    return null;
}

/* ---------- SHOW CARD ---------- */
function showCard(cardNode) {
    contentDiv.querySelectorAll('.card').forEach(c => c.remove());
    contentDiv.appendChild(cardNode);
    cardNode.classList.add('active');
}

/* ---------- UTILS ---------- */
function escape(txt) {
    if (!txt) return '';
    return String(txt).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}
function showError(msg) {
    contentDiv.innerHTML = `<div class="error">${msg}</div>`;
}
</script>
</body>
</html>
